name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  check:
    name: Check
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install dependencies
        run: pnpm install

      - name: Create placeholder binary for CI check
        run: |
          mkdir -p src-tauri/binaries
          touch src-tauri/binaries/cliproxyapi-aarch64-apple-darwin
          chmod +x src-tauri/binaries/cliproxyapi-aarch64-apple-darwin

      - name: TypeScript check
        run: pnpm tsc --noEmit

      - name: Rust check
        run: cargo check
        working-directory: src-tauri

  build:
    name: Build (${{ matrix.platform }})
    needs: check
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macOS-ARM
            os: macos-latest
            target: aarch64-apple-darwin
            artifact_path: src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
          - platform: macOS-Intel
            os: macos-15-intel
            target: x86_64-apple-darwin
            artifact_path: src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
          - platform: Linux
            os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            artifact_path: src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/deb/*.deb
          - platform: Windows
            os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_path: src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install dependencies
        run: pnpm install

      - name: Download CLIProxyAPI binary
        shell: bash
        run: |
          mkdir -p src-tauri/binaries
          VERSION=$(curl -s https://api.github.com/repos/router-for-me/CLIProxyAPI/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')

          case "${{ matrix.target }}" in
            aarch64-apple-darwin)
              ASSET="CLIProxyAPI_${VERSION}_darwin_arm64.tar.gz"
              BINARY="cliproxyapi-aarch64-apple-darwin"
              ;;
            x86_64-apple-darwin)
              ASSET="CLIProxyAPI_${VERSION}_darwin_amd64.tar.gz"
              BINARY="cliproxyapi-x86_64-apple-darwin"
              ;;
            x86_64-unknown-linux-gnu)
              ASSET="CLIProxyAPI_${VERSION}_linux_amd64.tar.gz"
              BINARY="cliproxyapi-x86_64-unknown-linux-gnu"
              ;;
            x86_64-pc-windows-msvc)
              ASSET="CLIProxyAPI_${VERSION}_windows_amd64.zip"
              BINARY="cliproxyapi-x86_64-pc-windows-msvc.exe"
              ;;
          esac

          echo "Downloading $ASSET..."
          curl -L -o /tmp/cliproxyapi.archive "https://github.com/router-for-me/CLIProxyAPI/releases/download/v${VERSION}/${ASSET}"

          cd /tmp
          if [[ "$ASSET" == *.zip ]]; then
            unzip -q cliproxyapi.archive
          else
            tar -xzf cliproxyapi.archive
          fi

          if [ -f "CLIProxyAPI" ]; then
            cp CLIProxyAPI "$GITHUB_WORKSPACE/src-tauri/binaries/$BINARY"
            chmod +x "$GITHUB_WORKSPACE/src-tauri/binaries/$BINARY"
          elif [ -f "CLIProxyAPI.exe" ]; then
            cp CLIProxyAPI.exe "$GITHUB_WORKSPACE/src-tauri/binaries/$BINARY"
          fi

          ls -la "$GITHUB_WORKSPACE/src-tauri/binaries/"

      - name: Build Tauri app
        shell: bash
        run: pnpm tauri build --target ${{ matrix.target }} --config '{"bundle":{"createUpdaterArtifacts":false}}'
        env:
          APPIMAGELAUNCHER_DISABLE: 1

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: proxypal-${{ matrix.target }}
          path: ${{ matrix.artifact_path }}
          if-no-files-found: error

  notify:
    name: Discord Notification
    needs: [check, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Discord notification (success)
        if: ${{ needs.check.result == 'success' && needs.build.result == 'success' }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"ProxyPal Build Passed\", \"description\": \"**Branch:** \`${{ github.ref_name }}\`\n**Commit:** [\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\n**Author:** ${{ github.actor }}\n\n:package: Artifacts ready for download\", \"color\": 3066993}]}" \
            $DISCORD_WEBHOOK

      - name: Discord notification (failure)
        if: ${{ needs.check.result == 'failure' || needs.build.result == 'failure' }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"ProxyPal Build Failed\", \"description\": \"**Branch:** \`${{ github.ref_name }}\`\n**Commit:** [\`${GITHUB_SHA::7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})\n**Author:** ${{ github.actor }}\n\n[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"color\": 15158332}]}" \
            $DISCORD_WEBHOOK
